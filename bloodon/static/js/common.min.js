"use strict";var BloodOn;BloodOn=BloodOn||{_projectPath:"",_main:null};$(document).ready(function(){var b=$("#contact_modal:eq(0)");var a=function(){b.modal("toggle")};$("#contact_us").click(a);(new BloodOn.ContactUs()).init(b)});"use strict";BloodOn.ContactUs=function(){this.content_=null;this.emailInput_=null;this.nameInput_=null;this.textInput_=null;this.form_=null};BloodOn.ContactUs.prototype={init:function(b){this.content_=b[0];var a=$("form",this.content_),d=a[0],e="#contact_us_",c=this;this.emailInput_=$(e+"email:eq(0)",d).keyup(function(){c.validate()})[0];this.nameInput_=$(e+"name:eq(0)",d).keyup(function(){c.validate()})[0];this.textInput_=$(e+"text:eq(0)",d).keyup(function(){c.validate()})[0];$(e+"submit:eq(0)",this.content_).click(function(){c.submit()});this.form_=d},validate:function(){var b=this.emailInput_,a=this.nameInput_,f=this.textInput_,d=this.form_,c="#contact_us_%s_validation:eq(0)";var e=Lib.isEmpty(b);this.changeIconState(b,$(c.replace("%s","email"),d),e);var h=Lib.isEmpty(a);this.changeIconState(a,$(c.replace("%s","name"),d),h);var g=Lib.isEmpty(f);this.changeIconState(f,$(c.replace("%s","text"),d),g);return(e&&h&&g)},changeIconState:function(b,a,d){var c=$(b).parents("div.control-group");c.removeClass(!d?"success":"error");c.addClass(d?"success":"error");a.css("backgroundColor",d?"green":"red").show()},submit:function(){if(!this.validate()){return false}Lib.Widget.overlay(this.content_,"loading");var a=$(this.form_);$.ajax({type:a.attr("method"),url:a.attr("action"),data:$.extend({},{email:this.emailInput_.value},{name:this.nameInput_.value},{text:this.textInput_.value},{csrfmiddlewaretoken:a.find('input[name="csrfmiddlewaretoken"]').val()}),success:$.proxy(this.successSubmit,this)});return true},successSubmit:function(b){Lib.Widget.unoverlay(this.content_);$(this.content_).modal("hide");var a=b.state;Lib.Widget.createMessage(b.message,b.state,true)}};window.BO=BloodOn;BloodOn.GeoTools=BloodOn.GeoTools||{};BloodOn.GeoTools={_map:null,_userMarker:null,_userCircleMarker:null,getMap:function(){return BloodOn.GeoTools._map},getUserMarker:function(){return BloodOn.GeoTools._userMarker},getUserCircleMarer:function(){return BloodOn.GeoTools._userCircleMarker},Marker:function(b,a){return L.marker(b,a)},LatLng:function(b,a){return L.latLng(b,a)},Icon:function(a){return L.icon(a)},divIcon:function(a){return L.divIcon(a)},LayerGroup:function(a){return L.layerGroup(a).addTo(BloodOn.GeoTools.getMap())},getMarker:function(a){return a.target},setIconMarker:function(a,b){a.setIcon(b)},bindMarkerEvents:function(a,d){for(var b in d){var c=b;BloodOn.GeoTools.bindMarkerEvent(a,c,d[c])}},bindMarkerEvent:function(a,c,b){a.on(c,function(d){b.call(a,d)})},setLatLng:function(a,b){a.setLatLng(b)},bindPopup:function(a,d,c,b){a.bindPopup(d,c);if(b){BO.GeoTools.openPopupMarker(a)}},openPopupMarker:function(a){a.openPopup()},closePopupMarker:function(a){a.closePopup()},parseCoordinate:function(a){return(typeof(a)==="string")?parseFloat(a.replace(",",".")):a},toggleLayerGroup:function(c,a){$(c).each(b);function b(){if(typeof(this)=="object"){BloodOn.GeoTools._map[(a?"add":"remove")+"Layer"](this)}}},panTo:function(b,a){b.panTo(a)},getDistance:function(e,d){var h=6371,i=(e[0]-d[0]).toRad(),b=(e[1]-d[1]).toRad(),g=e[0].toRad(),f=d[0].toRad(),k=Math.sin(i/2)*Math.sin(i/2)+Math.sin(b/2)*Math.sin(b/2)*Math.cos(g)*Math.cos(f),j=2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k));return h*j},getBound:function(e,c,b,d){var h=BO.GeoTools._map,f=h.getBounds(),a=h.getCenter(),g=h.getZoom();$.ajax({type:"get",url:e,data:$.extend({e:f.getEast(),w:f.getWest(),s:f.getSouth(),n:f.getNorth(),center:a.lat+"#"+a.lng,zoom:g},d),success:function(i){c.call(b,i)},error:function(){}})},getCircleBound:function(d,c,b,f){var g=BO.GeoTools._map,a=g.getCenter(),e=g.getZoom();$.ajax({type:"get",url:d,data:$.extend({radius:f.radius,lat:f.lat,lng:f.lng},{center:a.lat+"#"+a.lng,zoom:e}),success:function(h){c.call(b,h)},error:function(){}})},bindMapEvent:function(d,a,c){if(!BloodOn.GeoTools._map.__appEvents){BloodOn.GeoTools._map.__appEvents={}}var b=function(){a.call(c)};BloodOn.GeoTools._map.__appEvents[d]=b;BloodOn.GeoTools._map.on(d,BloodOn.GeoTools._map.__appEvents[d])},offEventMap:function(a){if(!BloodOn.GeoTools._map.__appEvents){return}if(!BloodOn.GeoTools._map.__appEvents[a]){return}BloodOn.GeoTools._map.off(a,BloodOn.GeoTools._map.__appEvents[a])},onEventMap:function(a,b){if(!BloodOn.GeoTools._map.__appEvents){return}if(!BloodOn.GeoTools._map.__appEvents[a]){return}BloodOn.GeoTools._map.on(a,BloodOn.GeoTools._map.__appEvents[a]);if(b){BloodOn.GeoTools._map.__appEvents[a]()}}};BloodOn.GeoTools.buildMap=function(c,d,h){var g=d,e=h;var f=$("#map_view_session:eq(0)"),i=$("#map_zoom_session:eq(0)");if(f.length){var a=f[0].lang.split("#");g=[BloodOn.GeoTools.parseCoordinate(a[0]),BloodOn.GeoTools.parseCoordinate(a[1])];e=BloodOn.GeoTools.parseCoordinate(i[0].lang)}var b=L.mapbox.map(c,"houssemfat.map-jrzf0li9").setView(g,e);L.control.scale().addTo(b);BloodOn.GeoTools._map=b};"use strict";BloodOn.AlertManager=function(){this.parent_;this.form_;this.url_="/create/";this.$placeIndicator;this.place_alert_id;this.date_alert;this.phone_num_alert;this.blood_id};BloodOn.AlertManager.prototype={init:function(j){this.content_=$("div#modal_alert")[0];this.parent_=j;var a=this,e=$("form#create_alert",this.content_),l=this.content_;this.form_=e[0];var i=$("#map-canvas");var k=$("#use_map_to_select_place:eq(0)");var t=function(){i.css({zIndex:0});$(a.content_).css({marginLeft:""});k.removeClass("icon-white").css("backgroundColor","");a.toggleOrganizationsMarkers(false);Lib.Widget.unoverlay(a.content_)};var m=function(){function u(){t()}$(a.content_).modal("toggle").on("hidden",u)};$("a#alert").click(m);var h=function(){if(!this._isShown){$(a.content_).css({marginLeft:"80px"});i.css({zIndex:20000});$(this).addClass("icon-white").css("backgroundColor","#0088cc");a.toggleOrganizationsMarkers(true)}else{t()}this._isShown=!this._isShown};k.click(h);var r=$("#place_input_validation:eq(0)",l),d=$("#places_of_donation",l),g=$("a#fake_place_of_donation",l);var o=function(){d.show();$(this).hide()};g.click(o);var n=function(){d.hide();g.show()};d.typeahead({source:function(u,v){return $.get("system/search/medical",{query:u},function(x){a.getPlacesKeys(x);var w=$.map(a.places_,function(y){return y.fields.name+"#"+y.fields.key_words+"#"+y.pk});v(w)})},matcher:function(u){var w=u.toLowerCase().split("#"),v=this.query.toLowerCase();if((w[0].indexOf(v)!=-1)||(w[1].indexOf(v)!=-1)){return true}},highlighter:function(v){var w=v.split("#"),u="<div class='typeahead`'>";u+="<span>"+w[0]+" ( "+w[1].substring(0,10)+"... )</span>";u+="</div>";return u},updater:function(u){if(u){var v=u.split("#");a.place_alert_id=v[2];a.changeIconState(d[0],r,true);d.hide();var w=v[0]+" "+v[1];g.html(w);n();return w}else{a.changeIconState(d[0],r,false)}}}).hide();a.inputPlaceValue=d[0];a.$iconPlaceValidation=r;a.$placeIndicator=g;var c=$("#date_input_validation:eq(0)",l),q=$("#time_of_donate",l).datepicker({onSelect:function(){a.validateDate(this,c)}}).prop("readonly",true);var s=function(){q.datepicker("show")};$("#fire_time_of_donate:eq(0)",l).click(s);var b=$("#phone_input_validation:eq(0)",l);var f=function(){a.validatePhone(this,b)};$("#alert_phone:eq(0)",l).keyup(f).change(f);var p=$("#blood_select_validation:eq(0)",l);$("#blood_select:eq(0)",l).change(function(){a.validateBlood(this,p)});$("#submit_alert").click(function(){a.submit()});this.registerOrganizationsMarkers()},validPost:function(){return((this.date_alert)&&(this.phone_num_alert)&&(this.place_alert_id)&&(this.blood_id))},text:function(){return $("#body_alert",this.content_).val()},validateBlood:function(b,a){var d=Math.abs(b[b.selectedIndex].id),c=d>0;this.blood_id=c?d:null;this.changeIconState(b,a,c)},validatePhone:function(e,k){var l="## ### ###",m=e.value,d=m.replace(/ /g,""),a=false;if(Math.floor(d)===parseFloat(d)){var h="",c=d.length,b=l.length,g=0,f=0;while(f<c&&g<b){if(l[g]==="#"){h+=d[f++]}else{h+=" "}g++}if(f<c){h+=d.substr(f)}e.value=h;if(c===8){a=true}else{a=false}}this.changeIconState(e,k,a);this.phone_num_alert=a?d:undefined;return a},validateDate:function(b,a){var d=b.value,c=d!=="";if(c){this.date_alert=b.value}else{this.date_alert=null}this.changeIconState(b,a,c);return c},changeIconState:function(b,a,d){var c=$(b).parents("div.control-group");c.removeClass(!d?"success":"error");c.addClass(d?"success":"error");a.css("backgroundColor",d?"green":"red").show()},getPlacesKeys:function(a){this.places_=$.parseJSON(a.data)},registerOrganizationsMarkers:function(){var b=this,a=[];$(".organization").each(function(){var k=this.id.split("#"),e=this,g=$.parseJSON($(e).attr("server")),j=g.title,h=BloodOn.GeoTools.Marker(new BloodOn.GeoTools.LatLng(BloodOn.GeoTools.parseCoordinate(k[0]),BloodOn.GeoTools.parseCoordinate(k[1]))),i=BloodOn.GeoTools.Icon({iconUrl:"https://a.tiles.mapbox.com/v3/marker/pin-m-hospital+f63a39.png"});h.__BOObject={type_:"organization",title_:j,id_:g.id};BloodOn.GeoTools.setIconMarker(h,i);a.push(h);BloodOn.GeoTools.bindPopup(h,j,{closeButton:false});function f(l){BloodOn.GeoTools.openPopupMarker(BloodOn.GeoTools.getMarker(l))}function d(l){BloodOn.GeoTools.closePopupMarker(BloodOn.GeoTools.getMarker(l))}function c(m){var l=BloodOn.GeoTools.getMarker(m);g=l.__BOObject;b.inputPlaceValue.value=j;b.place_alert_id=g.id_;b.$placeIndicator.html(j);$(b.inputPlaceValue).blur();b.changeIconState(b.inputPlaceValue,b.$iconPlaceValidation,true)}BloodOn.GeoTools.bindMarkerEvents(h,{mouseover:f,mouseout:d,click:c})}).hide();if(a.length>0){b.organizationsLayer_=BloodOn.GeoTools.LayerGroup(a);b.toggleOrganizationsMarkers(false)}},toggleOrganizationsMarkers:function(a){BloodOn.GeoTools.toggleLayerGroup(this.organizationsLayer_,a)},submit:function(){if(!this.validPost()){return false}Lib.Widget.overlay(this.content_,"loading");var a=$(this.form_);$.ajax({type:a.attr("method"),url:this.url_,data:$.extend({},{blood:this.blood_id},{text:this.text()},{organization:this.place_alert_id},{date_for:this.date_alert},{contact:this.phone_num_alert},{csrfmiddlewaretoken:a.find('input[name="csrfmiddlewaretoken"]').val()}),success:$.proxy(this.successSubmit,this),error:$.proxy(this.failSubmit,this)})},successSubmit:function(a){Lib.Widget.unoverlay(this.content_);$(this.content_).modal("hide")},failSubmit:function(a){Lib.Widget.unoverlay(this.content_)}};"use strict";BloodOn.CalendarManager=function(a){this.parent_=a;this.content_=$("div#container-calendar:eq(0)")[0];this.modal_=$("div#modal_calendar:eq(0)")[0];this.url_="home/calendar/event/";this.infoUrl_=this.url_+"show/";this.detailsUrl_=this.url_+"details/%d/%p";this.dateToLoad_=null;this.title_=null};BloodOn.CalendarManager.prototype={init:function(){var c=this;$(".alert-event",this.content_).mouseenter(function(){c.submit($(this).parent()[0])}).mouseleave(function(){$(this).popover("destroy")}).click(function(){c.getEventDetails(true,$(this).parent()[0])});var a=$("#show_calendar"),b=$("#main_calendar_view");a.click(function(d){d.preventDefault();b.slideToggle()});$("#load_more",this.modal_).mouseenter(function(){c.getEventDetails(false,undefined)});b.draggable().click(function(d){d.stopPropagation()})},submit:function(a){$.ajax({type:"get",url:this.infoUrl_+a.id+"/",success:function(b){$(this).popover("destroy");$(a).find(".alert-event:eq(0)").popover({html:true,content:b.html,title:a.id}).popover("show")},error:function(b){Lib.Widget.unoverlay(this.content_)}})},getEventDetails:function(c,b){if(c){this.dateToLoad_=b.id;this.title_=b.title_;this.pagecount_=0}var a=this.detailsUrl_;a=a.replace("%p",String(this.pagecount_));a=a.replace("%d",this.dateToLoad_);$.ajax({type:"get",url:a,success:$.proxy(this.successGetEventDetails,this,c),error:function(){}})},successGetEventDetails:function(b,e){var a=$(e.html),g=$(this.modal_),c=g[0],d=g.find("#alerts_body:eq(0)",c),f=g.find(".modal-title:eq(0)",c).html(this.title_);if(b){d.empty()}d.append(a);this.pagecount_=d.find(".app-alert-item").length;a.find(".share-item").click(function(){$(this).closest(".item-actions").find(".share-inside").slideToggle()});a.find(".send-to-item").click(function(){var h=$(this).closest(".app-alert-item"),i=h.find(".app-alert-item-body").html().replace("<br>"," : ");BloodOn.OrganizationManager.sendMeAsMessage(h.attr("id"),i,g)});g.modal("show")}};BloodOn.Main=function(){this.organizations_={};this.placeInfoModal_=$("#place_alerts_details")[0];this.getPlaceInfoModal=function(){return this.placeInfoModal_};this.activeAlertPlace_=null;this.userMarker_=null;this.menuChoices_=null;this.$timeLineContainer_=null;this.getTimeLineContainer=function(){return this.$timeLineContainer_};this.$timeLineCurosr_=null};BloodOn.Main.prototype={init:function(){var c=this;BloodOn.GeoTools.buildMap("map-canvas",[34,9],10);this.userMarker_=new BloodOn.UserMarker(c);this.userMarker_.init();new BloodOn.CalendarManager(this).init();this.menuChoices_=new BloodOn.MapChoices();this.menuChoices_.init(this);new BloodOn.AlertManager().init(this);$("a#btn_enter").click(function(){$("div#sing_in_modal:eq(0)").modal("toggle")});BloodOn.GeoTools.bindMapEvent("moveend",this.refreshMap,this);$(".place-alert-load-more",this.placeInfoModal_).click(function(){c.getMoreAlertsPlace(c.activeAlertPlace_)});var e=$("#time_line:eq(0)"),b=e[0],a=$("#app_alerts_scroll",b),d=$("#app_alerts_container",b);this.$timeLineCurosr_=a;this.$timeLineContainer_=d;this.refreshMap();this.registerAlerts()},refreshMap:function(){BO.GeoTools.getBound("/home/map/refresh",this.successRefreshMap,this)},refreshMapWithCircle:function(a){BO.GeoTools.getCircleBound("/home/map/refresh/around",this.successRefreshMap,this,a)},successRefreshMap:function(a){if(a.html){var d=a.html,c,e;for(var b=0;b<d.length;b++){c=d[b];e=c.organization__id;if(!this.organizations_[e]){this.organizations_[e]=new BloodOn.OrganizationManager(this,e,c)}}}},getMoreAlertsPlace:function(a){a.getMarkerDetails(false)},setActiveOrganization:function(a){this.activeAlertPlace_=a},registerAlerts:function(){var a=this,b=a.getTimeLineContainer();b.find(".share-item",b[0]).click(function(){$(this).closest(".item-actions").find(".share-inside").slideToggle();$(this).button("toggle")});b.find(".send-to-item").click(function(){var c=$(this).closest(".app-alert-item"),d=c.find(".app-alert-item-body").html().replace("<br>"," : ");BloodOn.OrganizationManager.sendMeAsMessage(c.attr("id"),d,null)})},updateScroll:function(){var j=$("#time_line:eq(0)"),d=this.$timeLineCurosr_,l=this.$timeLineContainer_,c=100,e=550,f=l.innerHeight()-e,i=Math.max(1,(f/c)),h=e/Math.max(1,(i-1)),g=e-h,k=g/Math.max(1,(i-1)),b=f/Math.max(1,(i)),a=this;d.css({height:Math.max(0,h)});j.mouseenter(function(){d.show()}).mouseleave(function(){d.hide()});l.bind("mousewheel DOMMouseScroll",function(p){var r=parseFloat(l[0].style.top)||0,o=parseFloat(d[0].style.top)||0,n=Math.floor(o/k),m=p.originalEvent,q=m.wheelDelta/120>0;if($.browser.mozilla){q=m.detail>0}r=(-(n*b))+((q)?b:-b);o=(n*k)+((q)?-k:+k);if(((Math.abs(r)+10)>f)||((o+10)<0)){return}if(((f-Math.abs(r))+10)<b){return}a.updateScrollBy(r,o)});d.draggable({axis:"y",containment:"parent",drag:function(p,q){var n=q.helper.context,r=parseFloat(n.style.top)||0,m=r/k,o=b*m;a.updateScrollBy(-o,r)},dragStop:function(p,q){var n=q.helper.context,r=parseFloat(n.style.top)||0,m=r/k,o=b*m;a.updateScrollBy(-o,m*k)}})},updateScrollBy:function(b,a){this.$timeLineContainer_.css({top:b});this.$timeLineCurosr_.css({top:a})}};$(document).ready(function(){BO._main=new BloodOn.Main().init()});BloodOn.UserMarker=function(a){this.parent_=a;this.serverPath_="/home/map/user/?";this.radius_=5000;this.arround_=null;this.container_=null;this.$zoomer_=null;this.$zoomerText_=null;this.marker_=null;this.getLatLng=function(){return this.marker_.getLatLng()}};BloodOn.UserMarker.prototype={init:function(){this.container_=$("li#user_marker_container:eq(0)")[0];var e=BloodOn.GeoTools._map,h=$("#map_user_session:eq(0)"),l=33.89415,a=9.03738,i=null,f=this,m=true,k=this.radius_;if(h[0]){var p=$(h).attr("infos").split("#");l=parseFloat(p[0]);a=parseFloat(p[1]);m=false;k=parseFloat(p[2])}var n={color:"gray",opacity:0.5,weight:3,fillColor:"white",fillOpacity:0.3},d=L.circle([l,a],k,n);this.arround_=d;var g=new L.LatLng(l,a),c=L.marker(g,{"marker-color":"#EDF107",draggable:true});function j(r){var q=r.target.getLatLng();d.setLatLng([q.lat,q.lng]);f.refreshMap()}c.on("drag",function(s,q){var r=s.target.getLatLng();d.setLatLng([r.lat,r.lng]);if(!e.getBounds().contains(r)){var t=e.latLngToLayerPoint(r);e.panBy([t.x-i.x,t.y-i.y],{animate:false})}i=e.latLngToLayerPoint(r)}).on("dragend",function(q){j(q)});function o(){var t="removeLayer",s=BloodOn.GeoTools.getMap(),q=BloodOn.GeoTools.getUserMarker(),r=BloodOn.GeoTools.getUserCircleMarer();$(this).button("toggle");s[t](q);s[t](r);$(this).parent().find("#inner").toggle("slide",{direction:"right"},500);BloodOn.GeoTools.onEventMap("moveend",true)}function b(){BloodOn.GeoTools.offEventMap("moveend");var t="addLayer",s=BloodOn.GeoTools.getMap(),q=BloodOn.GeoTools.getUserMarker(),r=BloodOn.GeoTools.getUserCircleMarer();$(this).button("toggle");s[t](q);s[t](r);if(m){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(u){var x=u.coords.latitude,w=u.coords.longitude,v=new BloodOn.GeoTools.LatLng(x,w);BloodOn.GeoTools.setLatLng(q,v);BloodOn.GeoTools.panTo(s,v);BloodOn.GeoTools.setLatLng(r,[x,w])})}else{this.innerHTML="Geolocation is not supported bythis browser, try using the cursor"}}s.panTo(q.getLatLng());$(this).parent().find("#inner").toggle("slide",{direction:"right"},500);f.refreshMap()}$("a#select_my_place",this.container_).toggle(b,o);this.buildZoomer();this.marker_=c;BloodOn.GeoTools._userMarker=c;BloodOn.GeoTools._userCircleMarker=d;this.updateSliderView((k/1000)*4,true)},buildZoomer:function(){var b=this,a=this.container_,h=$("#zoom_circle_container",a),e=h[0],f=$("#slider",e),c=$("#slider_text",e);var g=function(l){var k=l?10:-10,j=f.width(),i=Math.min(j+k,200);b.updateSliderView(i)};$("i#zoom_minus",h).click(function(){g(false)});$("i#zoom_plus",e).click(function(){g(true)});var d=function(l){var m=$(this).parent().offset(),k=l.clientX;var j=(k-m.left),i=Math.round(j/10)*10;b.updateSliderView(i)};$("div#slider_bg",e).click(d);f.click(d);b.$zoomer_=f;b.$zoomerText_=c},updateSliderView:function(a,b){var c=Math.min(a,200);c=Math.max(10,c);this.$zoomer_.css("width",c);var d=(c/2);this.$zoomerText_.css("marginLeft",c).html(d);this.setRadius(d*1000/2);if(!b){this.refreshMap()}},setRadius:function(a){this.radius_=a/2;this.arround_.setRadius(a/2)},refreshMap:function(){var a=this.getLatLng();this.parent_.refreshMapWithCircle({radius:this.radius_,lng:a.lng,lat:a.lat})}};BloodOn.MapChoices=function(){this.parent_=null;this.exculdeChoices_=[]};BloodOn.MapChoices.prototype={init:function(c){this.parent_=c;this.container_=$("li#map_blood_choices:eq(0)")[0];var a=this.container_,b=this;function e(){}$("a#filter_choices_btn",a).click(function(){$(this).button("toggle");$(this).parent().find("#inner").toggle("slide",{direction:"right"},500)});var d=$(".blood-choice",a).click(function(){var f=this;b.excludeChoice(f,f.__appIncludeMe?true:false);f.__appIncludeMe=!f.__appIncludeMe}).each(function(){this.__appIncludeMe=true});$("#blood_choice_all",a).click(function(){d.each(function(){$(this).find("span").addClass("blood-choice-on");this.__appIncludeMe=true})})},excludeChoice:function(b,a){this.exculdeChoices_[a?"push":"pop"](b.id);$(b).find("span")[(a?"remove":"add")+"Class"]("blood-choice-on")}};"use strict";BloodOn.MessageMeManager=function(a){this.emails_=[];this.content_=a[0];this.form_=null;this.url_="home/share/send-mail/";this.text_=null};BloodOn.MessageMeManager.prototype={init:function(){var a=this.content_,b=this,c="#send_to_",d=$(c+"list_addresses:eq(0)",a);$(c+"email:eq(0)",a).keyup(function(h){if(h.keyCode==13){var k=b.emails_,i=this.value;if(k.indexOf(i)>-1){return}if(Lib.isEmail(this.value)){var g=$('<span class="email-item-message"></span>'),f=g[0];$('<span class="email-item-text">'+i+"</span>").appendTo(f);g.appendTo(d);var j=$('<span class="delete hand" >Ã—</span>').appendTo(f).click(function(){g.remove();b.emails_=Lib.popFromArray(k,i)});b.emails_.push(i)}else{$(this).css({color:"red"});var e=this;setTimeout(function(){$(e).css({color:""})},2000)}}});this.text_=$(c+"text:eq(0)",a)[0];this.form_=$("form",a).submit(function(){return false})[0];$(c+"send_button:eq(0)",a).click(function(){b.sendMessage()})},sendMessage:function(){var d=this.emails_.length,f=this.emails_,c="",a=BloodOn.OrganizationManager.MessageToID,e=this.text_.value;if(d<1){return}for(var b=0;b<d;b++){c+=f[b]+"#"}Lib.Widget.overlay(this.content_,"loading");$.post(this.url_,$.extend({list:c,id:a,text:e},{csrfmiddlewaretoken:$(this.form_).find('input[name="csrfmiddlewaretoken"]').val()}),$.proxy(this.successSubmit,this))},successSubmit:function(a){Lib.Widget.unoverlay(this.content_);$(this.content_).modal("hide")}};"use strict";BloodOn.OrganizationManager=function(a,c,b){this.parent_=a;this.title_=null;this.id_=c;this.marker_=null;this.pagecount_=0;this.basicUrl_="/home/place/";this.infosUrl_=this.basicUrl_+"infos/%s/".replace("%s",this.id_);this.detailsUrl_=this.basicUrl_+"details/%s/%p/".replace("%s",this.id_);this.$sendToModal_=null;this.sendMeToID_=null;this.alertsCount_=0;this.init(b)};BloodOn.OrganizationManager.prototype={init:function(g){var b=BO.GeoTools._map,m={html:""},j,a,e,k,f,i,d=this,h="organization";f=Lib.getRandomColor();j=BO.GeoTools.parseCoordinate(g[h+"__latitude"]);a=BO.GeoTools.parseCoordinate(g[h+"__longitude"]);i=g.count;m.html='<div style="background-color:'+f+'">'+i+"</div>";k=g[h+"__name"];e=BO.GeoTools.Marker([j,a],{icon:BO.GeoTools.divIcon(m),title:k});e.addTo(b);this.alertsCount_=i;this.title_=k;this.marker_=e;var d=this,l=function(n){d.getMarkerInfo()};var c=function(n){d.getMarkerDetails(true)};BO.GeoTools.bindMarkerEvents(e,{mouseover:l,click:c})},getMarkerInfo:function(){$.ajax({type:"get",url:this.infosUrl_,success:$.proxy(this.successGetMarkerInfo,this),error:function(){}})},successGetMarkerInfo:function(a){BloodOn.GeoTools.bindPopup(this.marker_,a.html,{},true)},getMarkerDetails:function(a){this.parent_.setActiveOrganization(this);if(a){this.pagecount_=0}$.ajax({type:"get",url:this.detailsUrl_.replace("%p",String(this.pagecount_)),success:$.proxy(this.successGetMarkerDetails,this,a),error:function(){}})},successGetMarkerDetails:function(b,d){var a=$(d.html),f=$(this.parent_.getPlaceInfoModal()),c=f.find("#place_alerts:eq(0)"),e=f.find(".modal-title:eq(0)").html(this.title_);if(b){c.empty()}c.append(a);this.pagecount_=c.find(".app-alert-item").length;a.find(".share-item").click(function(){$(this).closest(".item-actions").find(".share-inside").slideToggle()});a.find(".send-to-item").click(function(){var g=$(this).closest(".app-alert-item"),h=g.find(".app-alert-item-body").html().replace("<br>"," : ");BloodOn.OrganizationManager.sendMeAsMessage(g.attr("id"),h,f)});f.modal("show")}};BloodOn.OrganizationManager.sendMeAsMessage=function(e,d,c){BloodOn.OrganizationManager.MessageToID=e;var a=BloodOn.OrganizationManager.jMessageToModal,b=a.find(".modal-title").empty().html(d);b.find("i").each(function(){$(this).addClass("icon-white")});a.modal("show");if(c){BloodOn.OrganizationManager.jbackModalToOpen=c;c.modal("hide")}else{BloodOn.OrganizationManager.jbackModalToOpen=undefined}};BloodOn.OrganizationManager.jMessageToModal=null;BloodOn.OrganizationManager.MessageToID=null;BloodOn.OrganizationManager.jbackModalToOpen=null;$(document).ready(function(){var a=$("#modal_send_to");a.on("hidden",function(){if(BloodOn.OrganizationManager.jbackModalToOpen){BloodOn.OrganizationManager.jbackModalToOpen.modal("show")}});BloodOn.OrganizationManager.jMessageToModal=a;(new BloodOn.MessageMeManager(a)).init()});